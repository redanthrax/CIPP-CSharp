@inject NavigationManager NavigationManager
@implements IDisposable

<MudNavMenu>
    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
        Dashboard
    </MudNavLink>
    <MudNavGroup Title="Tenant Administration" Icon="@Icons.Material.Filled.Business" Expanded="@_tenantAdminExpanded">
        <MudNavGroup Title="Administration" Icon="@Icons.Material.Filled.AdminPanelSettings" Expanded="@_administrationExpanded">
            <MudNavLink Href="/tenant/administration/tenants" Icon="@Icons.Material.Filled.List">
                Tenants
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/alert-configuration" Icon="@Icons.Material.Filled.Notifications">
                Alert Configuration
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/audit-logs" Icon="@Icons.Material.Filled.History">
                Audit Logs
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/applications" Icon="@Icons.Material.Filled.Apps">
                Applications
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/securescore" Icon="@Icons.Material.Filled.Security">
                Secure Score
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/app-consent-requests" Icon="@Icons.Material.Filled.AppRegistration">
                App Consent Requests
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/authentication-methods" Icon="@Icons.Material.Filled.VpnKey">
                Authentication Methods
            </MudNavLink>
            <MudNavLink Href="/tenant/administration/partner-relationships" Icon="@Icons.Material.Filled.Handshake">
                Partner Relationships
            </MudNavLink>
        </MudNavGroup>
        <MudNavLink Href="/tenant/gdap-management" Icon="@Icons.Material.Filled.ManageAccounts">
            GDAP Management
        </MudNavLink>
        <MudNavGroup Title="Standards & Drift" Icon="@Icons.Material.Filled.Rule" Expanded="@_standardsExpanded">
            <MudNavLink Href="/tenant/standards/list-standards" Icon="@Icons.Material.Filled.Rule">
                Standards Management
            </MudNavLink>
            <MudNavLink Href="/tenant/standards/bpa-report" Icon="@Icons.Material.Filled.Analytics">
                Best Practice Analyser
            </MudNavLink>
            <MudNavLink Href="/tenant/standards/domains-analyser" Icon="@Icons.Material.Filled.Domain">
                Domains Analyser
            </MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Conditional Access" Icon="@Icons.Material.Filled.Policy" Expanded="@_conditionalAccessExpanded">
            <MudNavLink Href="/tenant/conditional/list-policies" Icon="@Icons.Material.Filled.Policy">
                CA Policies
            </MudNavLink>
            <MudNavLink Href="/tenant/conditional/deploy-vacation" Icon="@Icons.Material.Filled.BeachAccess">
                CA Vacation Mode
            </MudNavLink>
            <MudNavLink Href="/tenant/conditional/list-template" Icon="@Icons.Material.Filled.DataObject">
                CA Templates
            </MudNavLink>
            <MudNavLink Href="/tenant/conditional/list-named-locations" Icon="@Icons.Material.Filled.LocationOn">
                Named Locations
            </MudNavLink>
        </MudNavGroup>
        <MudNavGroup Title="Reports" Icon="@Icons.Material.Filled.Assessment" Expanded="@_reportsExpanded">
            <MudNavLink Href="/tenant/reports/list-licenses" Icon="@Icons.Material.Filled.Description">
                Licence Report
            </MudNavLink>
            <MudNavLink Href="/tenant/reports/list-csp-licenses" Icon="@Icons.Material.Filled.BusinessCenter">
                Sherweb Licence Report
            </MudNavLink>
            <MudNavLink Href="/tenant/reports/application-consent" Icon="@Icons.Material.Filled.AppSettingsAlt">
                Consented Applications
            </MudNavLink>
        </MudNavGroup>
    </MudNavGroup>
    <MudNavGroup Title="CIPP" Icon="@Icons.Material.Filled.Settings" Expanded="@_cippExpanded">
        <MudNavLink Href="/cipp/settings" Icon="@Icons.Material.Filled.Settings">
            Application Settings
        </MudNavLink>
        <MudNavLink Href="/cipp/usersroles" Icon="@Icons.Material.Filled.Person">
            Users and Roles
        </MudNavLink>
    </MudNavGroup>
</MudNavMenu>

@code {
    private bool _tenantAdminExpanded;
    private bool _administrationExpanded;
    private bool _standardsExpanded;
    private bool _conditionalAccessExpanded;
    private bool _reportsExpanded;
    private bool _cippExpanded;

    protected override void OnInitialized()
    {
        UpdateExpandedStates();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        UpdateExpandedStates();
        StateHasChanged();
    }

    private void UpdateExpandedStates()
    {
        var currentPath = NavigationManager.Uri.Replace(NavigationManager.BaseUri, "/").ToLowerInvariant();
        
        _administrationExpanded = currentPath.Contains("/tenant/administration/");
        _standardsExpanded = currentPath.Contains("/tenant/standards/");
        _conditionalAccessExpanded = currentPath.Contains("/tenant/conditional/");
        _reportsExpanded = currentPath.Contains("/tenant/reports/");
        _cippExpanded = currentPath.Contains("/cipp/");
        
        _tenantAdminExpanded = _administrationExpanded || _standardsExpanded || 
                               _conditionalAccessExpanded || _reportsExpanded || 
                               currentPath.Contains("/tenant/gdap-management");
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}

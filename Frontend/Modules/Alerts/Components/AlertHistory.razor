@page "/tenant/administration/alert-history"
@attribute [Authorize]
@using CIPP.Frontend.Modules.Authentication.Interfaces
@using CIPP.Shared.DTOs.Alerts
@using CIPP.Frontend.Modules.Notifications.Interfaces
@using System.Text.Json

@inject ICippApiClient ApiClient
@inject INotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Alert History - CIPP</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Alert History</MudText>
            <MudButton Variant="Variant.Outlined"
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="RefreshData"
                      Disabled="@_loading">
                Refresh
            </MudButton>
        </MudStack>

        <MudPaper Class="pa-4" Elevation="2">
            <MudStack Row Spacing="3" AlignItems="AlignItems.End">
                <MudTextField @bind-Value="_searchText"
                             Label="Search"
                             Placeholder="Search by tenant, title, or IP..."
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             Immediate="true"
                             DebounceInterval="300"
                             OnDebounceIntervalElapsed="OnSearchChanged"
                             Style="min-width: 300px;" />
                
                <MudSelect @bind-Value="_logTypeFilter" 
                          Label="Log Type" 
                          Clearable="true"
                          Style="min-width: 150px;">
                    <MudSelectItem Value="@((string?)null)">All Types</MudSelectItem>
                    <MudSelectItem Value="@("Audit.AzureActiveDirectory")">Azure AD</MudSelectItem>
                    <MudSelectItem Value="@("Audit.Exchange")">Exchange</MudSelectItem>
                    <MudSelectItem Value="@("Scripted")">Scripted</MudSelectItem>
                </MudSelect>

                <MudDateRangePicker @bind-DateRange="_dateRange"
                                   Label="Date Range"
                                   DateFormat="yyyy-MM-dd"
                                   Clearable="true"
                                   Style="min-width: 250px;" />
            </MudStack>
        </MudPaper>

        <MudPaper Class="overflow-hidden" Elevation="2">
            <MudDataGrid T="AlertHistoryDto" 
                         Items="@_filteredHistory" 
                         @ref="_dataGrid"
                         Loading="@_loading"
                         Filterable="true"
                         SortMode="@SortMode.Multiple"
                         RowsPerPage="25"
                         Hover="true"
                         Dense="true"
                         RowClick="@OnRowClick">
                <Columns>
                    <PropertyColumn Property="x => x.CreatedAt" Title="Triggered At" Sortable="true" Format="yyyy-MM-dd HH:mm:ss">
                        <CellTemplate>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@context.Item.CreatedAt.ToString("yyyy-MM-dd")</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.CreatedAt.ToString("HH:mm:ss")</MudText>
                            </MudStack>
                        </CellTemplate>
                    </PropertyColumn>

                    <PropertyColumn Property="x => x.Title" Title="Alert Title" Sortable="true" Filterable="true">
                        <CellTemplate>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                @context.Item.Title
                            </MudText>
                        </CellTemplate>
                    </PropertyColumn>

                    <PropertyColumn Property="x => x.TenantFilter" Title="Tenant" Sortable="true" Filterable="true">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                @context.Item.TenantFilter
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>

                    <PropertyColumn Property="x => x.LogType" Title="Log Type" Sortable="true" Filterable="true">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small" 
                                    Color="@GetLogTypeColor(context.Item.LogType)"
                                    Variant="Variant.Filled">
                                @context.Item.LogType
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>

                    <PropertyColumn Property="x => x.IpAddress" Title="IP Address" Sortable="false" Filterable="false">
                        <CellTemplate>
                            @if (!string.IsNullOrEmpty(context.Item.IpAddress))
                            {
                                <MudText Typo="Typo.body2">@context.Item.IpAddress</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                            }
                        </CellTemplate>
                    </PropertyColumn>

                    <TemplateColumn Title="Actions" Sortable="false" Filterable="false">
                        <CellTemplate>
                            <MudTooltip Text="View Details">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                              Size="Size.Small"
                                              Color="Color.Primary"
                                              OnClick="@(() => ViewDetails(context.Item))" />
                            </MudTooltip>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>

                <PagerContent>
                    <MudDataGridPager T="AlertHistoryDto" />
                </PagerContent>
            </MudDataGrid>
        </MudPaper>
    </MudStack>
</MudContainer>

<MudDialog @bind-IsVisible="_detailsDialogVisible" Options="new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true }">
    <TitleContent>
        <MudText Typo="Typo.h6">Alert Details</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedAlert != null)
        {
            <MudStack Spacing="3">
                <MudPaper Class="pa-3" Elevation="0" Square="true">
                    <MudStack Spacing="2">
                        <MudStack Row Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">Alert ID:</MudText>
                            <MudText Typo="Typo.body2">@_selectedAlert.Id</MudText>
                        </MudStack>
                        <MudStack Row Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">Title:</MudText>
                            <MudText Typo="Typo.body2">@_selectedAlert.Title</MudText>
                        </MudStack>
                        <MudStack Row Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">Tenant:</MudText>
                            <MudText Typo="Typo.body2">@_selectedAlert.TenantFilter</MudText>
                        </MudStack>
                        <MudStack Row Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">Log Type:</MudText>
                            <MudText Typo="Typo.body2">@_selectedAlert.LogType</MudText>
                        </MudStack>
                        <MudStack Row Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.subtitle2">Triggered At:</MudText>
                            <MudText Typo="Typo.body2">@_selectedAlert.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                        </MudStack>
                        @if (!string.IsNullOrEmpty(_selectedAlert.IpAddress))
                        {
                            <MudStack Row Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.subtitle2">IP Address:</MudText>
                                <MudText Typo="Typo.body2">@_selectedAlert.IpAddress</MudText>
                            </MudStack>
                        }
                    </MudStack>
                </MudPaper>

                <MudPaper Class="pa-3" Elevation="0" Square="true">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Raw Data:</MudText>
                    <MudPaper Class="pa-2" Elevation="0" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                        <pre style="margin: 0; font-size: 0.875rem;">@FormatJson(_selectedAlert.RawData)</pre>
                    </MudPaper>
                </MudPaper>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" OnClick="@(() => _detailsDialogVisible = false)">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudDataGrid<AlertHistoryDto>? _dataGrid;
    private List<AlertHistoryDto> _history = new();
    private List<AlertHistoryDto> _filteredHistory = new();
    
    private bool _loading = false;
    private string _searchText = "";
    private string? _logTypeFilter = null;
    private DateRange? _dateRange = null;
    private bool _detailsDialogVisible = false;
    private AlertHistoryDto? _selectedAlert = null;

    protected override async Task OnInitializedAsync() {
        await LoadHistory();
    }

    private async Task LoadHistory() {
        _loading = true;
        StateHasChanged();

        try {
            var queryParams = new List<string>();
            
            if (!string.IsNullOrEmpty(_logTypeFilter)) {
                queryParams.Add($"logType={Uri.EscapeDataString(_logTypeFilter)}");
            }
            
            if (_dateRange?.Start != null) {
                queryParams.Add($"startDate={_dateRange.Start.Value:yyyy-MM-dd}");
            }
            
            if (_dateRange?.End != null) {
                queryParams.Add($"endDate={_dateRange.End.Value:yyyy-MM-dd}");
            }

            var query = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var result = await ApiClient.GetAsync<PagedResponse<AlertHistoryDto>>($"/v1/alerts/history{query}");
            
            if (result?.Success == true && result.Data != null) {
                _history = result.Data.Items;
                ApplyFilters();
            } else {
                NotificationService.ShowError($"Error loading alert history: {result?.Message ?? "Unknown error"}");
            }
        } catch (Exception ex) {
            NotificationService.ShowError($"Error loading alert history: {ex.Message}");
        } finally {
            _loading = false;
            StateHasChanged();
        }
    }

    private void ApplyFilters() {
        _filteredHistory = _history.Where(alert => {
            if (!string.IsNullOrEmpty(_searchText)) {
                var searchLower = _searchText.ToLowerInvariant();
                var searchMatch = alert.Title.ToLowerInvariant().Contains(searchLower) ||
                                alert.TenantFilter.ToLowerInvariant().Contains(searchLower) ||
                                (alert.IpAddress?.ToLowerInvariant().Contains(searchLower) ?? false);
                
                if (!searchMatch) {
                    return false;
                }
            }

            return true;
        }).ToList();

        StateHasChanged();
    }

    private async Task RefreshData() {
        await LoadHistory();
    }

    private void OnSearchChanged(string text) {
        _searchText = text;
        ApplyFilters();
    }

    private void OnRowClick(DataGridRowClickEventArgs<AlertHistoryDto> args) {
        ViewDetails(args.Item);
    }

    private void ViewDetails(AlertHistoryDto alert) {
        _selectedAlert = alert;
        _detailsDialogVisible = true;
    }

    private Color GetLogTypeColor(string logType) {
        return logType switch {
            "Audit.AzureActiveDirectory" => Color.Primary,
            "Audit.Exchange" => Color.Info,
            "Scripted" => Color.Success,
            _ => Color.Default
        };
    }

    private string FormatJson(string json) {
        try {
            var obj = JsonSerializer.Deserialize<JsonElement>(json);
            return JsonSerializer.Serialize(obj, new JsonSerializerOptions {
                WriteIndented = true
            });
        } catch {
            return json;
        }
    }
}

@page "/tenant/administration/alert-dashboard"
@attribute [Authorize]
@using CIPP.Frontend.Modules.Authentication.Interfaces
@using CIPP.Shared.DTOs.Alerts
@using CIPP.Frontend.Modules.Notifications.Interfaces

@inject ICippApiClient ApiClient
@inject INotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Alert Dashboard - CIPP</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Alert Dashboard</MudText>
            <MudButton Variant="Variant.Outlined"
                      StartIcon="@Icons.Material.Filled.Refresh"
                      OnClick="RefreshData"
                      Disabled="@_loading">
                Refresh
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (_statistics != null)
        {
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Notifications" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_statistics.TotalAlerts</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Total Alerts</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Rule" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_statistics.ActiveRules</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Active Rules</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Today" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_statistics.TriggeredToday</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Triggered Today</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Color="Color.Warning" Size="Size.Large" />
                            <MudText Typo="Typo.h4">@_statistics.TriggeredThisMonth</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Triggered This Month</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-4">Alerts by Type</MudText>
                        @if (_statistics.AlertsByType.Any())
                        {
                            <MudStack Spacing="2">
                                @foreach (var (type, count) in _statistics.AlertsByType.OrderByDescending(x => x.Value))
                                {
                                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudChip T="string" Size="Size.Small" Color="GetTypeColor(type)">@type</MudChip>
                                        <MudText Typo="Typo.body1">@count</MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No data available</MudText>
                        }
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-4">Top Tenants</MudText>
                        @if (_statistics.AlertsByTenant.Any())
                        {
                            <MudStack Spacing="2">
                                @foreach (var (tenant, count) in _statistics.AlertsByTenant.OrderByDescending(x => x.Value).Take(5))
                                {
                                    <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.body2" Style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">@tenant</MudText>
                                        <MudChip T="string" Size="Size.Small">@count</MudChip>
                                    </MudStack>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No data available</MudText>
                        }
                    </MudPaper>
                </MudItem>

                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="2">
                        <MudStack Row Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                            <MudText Typo="Typo.h6">Recent Alerts</MudText>
                            <MudButton Variant="Variant.Text" 
                                      Color="Color.Primary" 
                                      OnClick="@(() => Navigation.NavigateTo("/tenant/administration/alert-history"))">
                                View All
                            </MudButton>
                        </MudStack>
                        @if (_statistics.RecentAlerts.Any())
                        {
                            <MudSimpleTable Dense="true" Hover="true">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Title</th>
                                        <th>Tenant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var alert in _statistics.RecentAlerts)
                                    {
                                        <tr style="cursor: pointer;" @onclick="@(() => ViewAlert(alert))">
                                            <td>@alert.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                            <td>@alert.Title</td>
                                            <td>
                                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                    @alert.TenantFilter
                                                </MudChip>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </MudSimpleTable>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No recent alerts</MudText>
                        }
                    </MudPaper>
                </MudItem>
            </MudGrid>
        }
    </MudStack>
</MudContainer>

@code {
    private AlertStatisticsDto? _statistics;
    private bool _loading = false;

    protected override async Task OnInitializedAsync() {
        await LoadStatistics();
    }

    private async Task LoadStatistics() {
        _loading = true;
        StateHasChanged();

        try {
            var result = await ApiClient.GetAsync<AlertStatisticsDto>("/v1/alerts/statistics");
            
            if (result?.Success == true && result.Data != null) {
                _statistics = result.Data;
            } else {
                NotificationService.ShowError($"Error loading statistics: {result?.Message ?? "Unknown error"}");
            }
        } catch (Exception ex) {
            NotificationService.ShowError($"Error loading statistics: {ex.Message}");
        } finally {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData() {
        await LoadStatistics();
    }

    private void ViewAlert(RecentAlertDto alert) {
        Navigation.NavigateTo("/tenant/administration/alert-history");
    }

    private Color GetTypeColor(string type) {
        return type switch {
            "Audit.AzureActiveDirectory" => Color.Primary,
            "Audit.Exchange" => Color.Info,
            "Scripted" => Color.Success,
            _ => Color.Default
        };
    }
}
